import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
import datetime as dt
from matplotlib.backends.backend_pdf import PdfPages
import pymysql
from sqlalchemy.types import String, Float, Integer,DECIMAL,VARCHAR
from sqlalchemy import DateTime
from sqlalchemy import create_engine
from sqlalchemy import exc
import os
import re
import data_organize as do
from WindPy import w
w.start()

from iFinDPy import *
thsLogin = THS_iFinDLogin("tpy1369","510083")


dur = pd.read_excel('Z:\\Users\\wdt\\Desktop\\tpy\\Modules\\signals\\dur_v2.xlsx',\
    index_col=0)
nav = pd.read_excel('Z:\\Users\\wdt\\Desktop\\tpy\\Modules\\signals\\fund_nav_v2.xlsx')
nav.index = nav.date

code_list = list(dur.columns)

_,df=w.wss(','.join(code_list), "fund_regulopenfundornot",usedf=True)
tmp=df.loc[df.iloc[:,0]=='是'].index
nav[tmp]

nav_2 = nav[code_list]
(nav_2==0).astype(int).sum()

nav['166904.OF'].value_counts()
(1+nav['000033.OF']/100)['2021'].cumprod().plot()
dur['000033.OF'].plot()



# 基金估值方法
df=w.wsd(','.join(code_list), "fund_valuationmethod", \
    "2015-08-17", "2021-08-17", "",usedf=True)
df=df[1]
df.dropna(axis=1)
df.isin(['摊余成本法']).sum(axis=0).sum()
(df=='摊余成本法').sum().sum()
# get top10 bonds

# get fund scale
df = THS_BD(','.join(code_list),'ths_fund_scale_fund','2021-08-23').data
df.loc[df['ths_fund_scale_fund']>500000000]
df.to_excel('dur_tot_fund_scale.xlsx',index=False)

df = THS_BD(','.join(code_list),'ths_mergesize_fund','2021-08-23').data
df.loc[df['ths_mergesize_fund']>500000000]


df=THS_BD('000005.OF,000015.OF,000016.OF,000024.OF,000025.OF,\
    000032.OF,000033.OF,000037.OF,000053.OF,000064.OF,000069.OF,\
    000070.OF,000074.OF,000077.OF,000078.OF,000079.OF,000080.OF,\
    000081.OF,000086.OF,000089.OF,000090.OF,000104.OF,000105.OF,\
    000106.OF,000111.OF,000112.OF,000113.OF,000115.OF,000116.OF,\
    000122.OF,000123.OF,000134.OF,000135.OF,000137.OF,000138.OF,\
    000139.OF,000141.OF,000147.OF,000148.OF,000149.OF,000150.OF,\
    000152.OF,000153.OF,000174.OF,000175.OF,000183.OF,000186.OF,\
    000187.OF,000188.OF,000191.OF,000192.OF,000194.OF,000200.OF,\
    000201.OF,000205.OF,000206.OF,000212.OF,000213.OF,000221.OF,\
    000222.OF,000227.OF,000235.OF,000239.OF,000240.OF,000244.OF,000245.OF,000246.OF,000252.OF,000253.OF,000254.OF,000255.OF,000265.OF,000266.OF,000267.OF,000268.OF,000271.OF,000272.OF,000277.OF,000286.OF,000289.OF,000295.OF,000296.OF,000298.OF,000299.OF,000305.OF,000310.OF,000319.OF,000320.OF,000322.OF,000329.OF,000335.OF,000345.OF,000346.OF,000347.OF,000372.OF,000395.OF,000396.OF,000402.OF,000403.OF,000415.OF,000416.OF,000419.OF,000420.OF,000465.OF,000469.OF,000487.OF,000488.OF,000489.OF,000490.OF,000497.OF,000501.OF,000502.OF,000516.OF,000517.OF,000521.OF,000546.OF,000552.OF,000553.OF,000561.OF,000562.OF,000563.OF,000564.OF,000583.OF,000606.OF,000655.OF,000694.OF,000715.OF,000720.OF,000728.OF,000736.OF,000737.OF,000744.OF,000745.OF,000783.OF,000784.OF,000792.OF,000799.OF,000801.OF,000802.OF,000814.OF,000815.OF,000817.OF,000833.OF,000839.OF,000840.OF,000898.OF,000899.OF,000910.OF,000911.OF,000914.OF,000931.OF,000943.OF,000944.OF,000997.OF,000998.OF,001011.OF,001013.OF,001019.OF,001212.OF,001213.OF,001235.OF,001246.OF,001299.OF,001368.OF,001369.OF,001516.OF,001545.OF,001546.OF,001578.OF,001619.OF,001661.OF,001750.OF,001776.OF,001783.OF,001784.OF,001785.OF,001794.OF,001819.OF,001859.OF,001860.OF,001906.OF,001911.OF,001918.OF,001919.OF,001945.OF,001946.OF,001950.OF,001960.OF,001961.OF,001963.OF,001964.OF,001968.OF,001969.OF,001988.OF,001989.OF,001993.OF,001994.OF,002048.OF,002073.OF,002074.OF,002101.OF,002102.OF,002109.OF,002128.OF,002140.OF,002143.OF,002169.OF,002175.OF,002188.OF,002198.OF,002206.OF,002218.OF,002219.OF,002254.OF,002255.OF,002265.OF,002268.OF,002274.OF,002275.OF,002276.OF,002277.OF,002279.OF,002336.OF,002337.OF,002338.OF,002341.OF,002342.OF,002344.OF,002354.OF,002356.OF,002357.OF,002377.OF,002381.OF,002382.OF,002395.OF,002396.OF,002404.OF,002405.OF,002406.OF,002438.OF,002442.OF,002445.OF,002447.OF,002448.OF,002452.OF,002466.OF,002476.OF,002477.OF,002483.OF,002486.OF,002487.OF,002488.OF,002490.OF,002491.OF,002507.OF,002519.OF,002520.OF,002523.OF,002524.OF,002528.OF,002529.OF,002548.OF,002549.OF,002550.OF,002552.OF,002568.OF,002569.OF,002578.OF,002586.OF,002587.OF,002592.OF,002600.OF,002603.OF,002625.OF,002635.OF,002638.OF,002650.OF,002661.OF,002684.OF,002698.OF,002704.OF,002705.OF,002716.OF,002734.OF,002735.OF,002736.OF,002737.OF,002740.OF,002741.OF,002750.OF,002754.OF,002755.OF,002756.OF,002757.OF,002775.OF,002781.OF,002795.OF,002805.OF,002806.OF,002807.OF,002811.OF,002812.OF,002817.OF,002818.OF,002825.OF,002826.OF,002830.OF,002832.OF,002858.OF,002859.OF,002868.OF,002869.OF,002870.OF,002881.OF,002882.OF,002898.OF,002899.OF,002904.OF,002905.OF,002909.OF,002915.OF,002927.OF,002928.OF,002929.OF,002930.OF,002964.OF,002970.OF,002985.OF,002991.OF,002994.OF,002995.OF,002996.OF,002997.OF,003013.OF,003014.OF,003023.OF,003024.OF,003039.OF,003040.OF,003041.OF,003050.OF,003051.OF,003056.OF,003065.OF,003066.OF,003071.OF,003072.OF,003073.OF,003074.OF,003078.OF,003102.OF,003103.OF,003121.OF,003123.OF,003124.OF,003130.OF,003146.OF,003155.OF,003156.OF,003157.OF,003159.OF,003160.OF,003162.OF,003163.OF,003173.OF,003174.OF,003179.OF,003188.OF,003192.OF,003193.OF,003195.OF,003196.OF,003199.OF,003200.OF,003207.OF,003209.OF,003210.OF,003213.OF,003214.OF,003220.OF,003223.OF,003226.OF,003227.OF,003239.OF,003240.OF,003258.OF,003259.OF,003260.OF,003265.OF,003266.OF,003268.OF,003269.OF,003270.OF,003273.OF,003274.OF,003275.OF,003276.OF,003277.OF,003278.OF,003280.OF,003285.OF,003286.OF,003287.OF,003288.OF,003289.OF,003290.OF,003297.OF,003309.OF,003310.OF,003313.OF,003314.OF,003315.OF,003324.OF,003325.OF,003327.OF,003328.OF,003329.OF,003330.OF,003337.OF,003338.OF,003349.OF,003357.OF,003382.OF,003383.OF,003384.OF,003390.OF,003394.OF,003395.OF,003400.OF,003406.OF,003407.OF,003408.OF,003417.OF,003418.OF,003424.OF,003425.OF,003426.OF,003427.OF,003428.OF,003438.OF,003439.OF,003440.OF,003441.OF,003442.OF,003443.OF,003445.OF,003448.OF,003449.OF,003450.OF,003451.OF,003452.OF,003453.OF,003454.OF,003455.OF,003457.OF,003461.OF,003486.OF,003487.OF,003497.OF,003498.OF,003499.OF,003500.OF,003514.OF,003517.OF,003518.OF,003519.OF,003520.OF,003521.OF,003526.OF,003527.OF,003528.OF,003529.OF,003532.OF,003533.OF,003542.OF,003547.OF,003549.OF,003564.OF,003565.OF,003566.OF,003568.OF,003569.OF,003570.OF,003571.OF,003572.OF,003573.OF,003574.OF,003575.OF,003583.OF,003584.OF,003590.OF,003605.OF,003607.OF,003614.OF,003615.OF,003618.OF,003619.OF,003637.OF,003638.OF,003640.OF,003648.OF,003651.OF,003656.OF,003657.OF,003660.OF,003661.OF,003662.OF,003664.OF,003665.OF,003668.OF,003669.OF,003671.OF,003672.OF,003673.OF,003674.OF,003681.OF,003682.OF,003683.OF,003696.OF,003703.OF,003708.OF,003709.OF,003728.OF,003730.OF,003733.OF,003741.OF,003742.OF,003746.OF,003747.OF,003748.OF,003767.OF,003768.OF,003770.OF,003776.OF,003777.OF,003787.OF,003788.OF,003793.OF,003794.OF,003795.OF,003796.OF,003809.OF,003810.OF,003811.OF,003812.OF,003819.OF,003824.OF,003825.OF,003832.OF,003837.OF,003838.OF,003841.OF,003859.OF,003860.OF,003863.OF,003864.OF,003866.OF,003867.OF,003868.OF,003869.OF,003879.OF,003880.OF,003888.OF,003891.OF,003898.OF,003922.OF,003923.OF,003926.OF,003927.OF,003928.OF,003929.OF,003930.OF,003949.OF,003952.OF,003953.OF,003963.OF,003978.OF,003979.OF,003983.OF,003999.OF,004001.OF,004002.OF,004020.OF,004021.OF,004022.OF,004024.OF,004027.OF,004028.OF,004030.OF,004031.OF,004032.OF,004033.OF,004038.OF,004042.OF,004043.OF,004045.OF,004052.OF,004053.OF,004059.OF,004061.OF,004062.OF,004066.OF,004079.OF,004080.OF,004087.OF,004089.OF,004090.OF,004101.OF,004102.OF,004103.OF,004104.OF,004105.OF,004106.OF,004107.OF,004108.OF,004109.OF,004117.OF,004118.OF,004122.OF,004123.OF,004124.OF,004127.OF,004134.OF,004136.OF,004140.OF,004141.OF,004168.OF,004180.OF,004181.OF,004196.OF,004197.OF,004200.OF,004220.OF,004230.OF,004238.OF,004242.OF,004246.OF,004247.OF,004254.OF,004255.OF,004256.OF,004264.OF,004307.OF,004322.OF,004333.OF,004334.OF,004356.OF,004366.OF,004367.OF,004386.OF,004387.OF,004388.OF,004389.OF,004400.OF,004401.OF,004438.OF,004441.OF,004458.OF,004459.OF,004463.OF,004464.OF,004465.OF,004469.OF,004470.OF,004479.OF,004498.OF,004499.OF,004503.OF,004504.OF,004544.OF,004548.OF,004555.OF,004556.OF,004567.OF,004601.OF,004614.OF,004615.OF,004629.OF,004630.OF,004632.OF,004637.OF,004638.OF,004639.OF,004655.OF,004656.OF,004681.OF,004682.OF,004689.OF,004705.OF,004706.OF,004722.OF,004723.OF,004728.OF,004729.OF,004736.OF,004767.OF,004780.OF,004781.OF,004782.OF,004797.OF,004800.OF,004821.OF,004825.OF,004826.OF,004831.OF,004832.OF,004838.OF,004844.OF,004859.OF,004882.OF,004887.OF,004893.OF,004894.OF,004897.OF,004898.OF,004899.OF,004910.OF,004911.OF,004912.OF,004919.OF,004920.OF,004921.OF,004922.OF,004923.OF,004924.OF,004940.OF,004941.OF,004954.OF,004955.OF,004956.OF,004957.OF,004960.OF,004978.OF,004979.OF,004980.OF,005024.OF,005025.OF,005047.OF,005048.OF,005054.OF,005068.OF,005069.OF,005070.OF,005072.OF,005073.OF,005074.OF,005077.OF,005099.OF,005124.OF,005127.OF,005158.OF,005159.OF,005160.OF,005171.OF,005172.OF,005200.OF,005201.OF,005208.OF,005213.OF,005214.OF,005234.OF,005277.OF,005286.OF,005289.OF,005307.OF,005308.OF,005309.OF,005315.OF,005316.OF,005321.OF,005322.OF,005327.OF,005336.OF,005337.OF,005338.OF,005340.OF,005345.OF,005346.OF,005361.OF,005362.OF,005363.OF,005364.OF,005365.OF,005366.OF,005367.OF,005369.OF,005375.OF,005377.OF,005378.OF,005383.OF,005384.OF,005388.OF,005393.OF,005394.OF,005398.OF,005407.OF,005408.OF,005410.OF,005411.OF,005419.OF,005420.OF,005423.OF,005424.OF,005425.OF,005426.OF,005427.OF,005428.OF,005431.OF,005432.OF,005435.OF,005436.OF,005439.OF,005442.OF,005446.OF,005448.OF,005451.OF,005452.OF,005455.OF,005462.OF,005465.OF,005466.OF,005467.OF,005468.OF,005469.OF,005470.OF,005476.OF,005480.OF,005485.OF,005488.OF,005497.OF,005501.OF,005507.OF,005508.OF,005525.OF,005529.OF,005531.OF,005532.OF,005547.OF,005548.OF,005556.OF,005573.OF,005574.OF,005575.OF,005577.OF,005578.OF,005579.OF,005580.OF,005590.OF,005591.OF,005594.OF,005595.OF,005606.OF,005610.OF,005611.OF,005617.OF,005622.OF,005625.OF,005631.OF,005637.OF,005641.OF,005645.OF,005647.OF,005648.OF,005649.OF,005654.OF,005655.OF,005666.OF,005667.OF,005670.OF,005677.OF,005678.OF,005684.OF,005685.OF,005690.OF,005703.OF,005704.OF,005705.OF,005709.OF,005710.OF,005712.OF,005713.OF,005714.OF,005718.OF,005719.OF,005720.OF,005721.OF,005722.OF,005723.OF,005731.OF,005736.OF,005740.OF,005745.OF,005749.OF,005750.OF,005751.OF,005752.OF,005753.OF,005766.OF,005772.OF,005778.OF,005779.OF,005780.OF,005781.OF,005782.OF,005783.OF,005784.OF,005785.OF,005786.OF,005790.OF,005791.OF,005792.OF,005816.OF,005817.OF,005818.OF,005820.OF,005828.OF,005831.OF,005836.OF,005837.OF,005841.OF,005842.OF,005845.OF,005846.OF,005849.OF,005853.OF,005854.OF,005857.OF,005858.OF,005862.OF,005863.OF,005864.OF,005871.OF,005872.OF,005879.OF,005882.OF,005884.OF,005890.OF,005891.OF,005892.OF,005893.OF,005895.OF,005896.OF,005897.OF,005898.OF,005917.OF,005920.OF,005921.OF,005931.OF,005932.OF,005936.OF,005951.OF,005952.OF,005964.OF,005971.OF,005972.OF,005973.OF,005988.OF,005989.OF,005990.OF,005995.OF,005996.OF,006011.OF,006012.OF,006015.OF,006016.OF,006023.OF,006024.OF,006026.OF,006027.OF,006029.OF,006032.OF,006035.OF,006036.OF,006037.OF,006040.OF,006043.OF,006044.OF,006045.OF,006047.OF,006053.OF,006054.OF,006055.OF,006065.OF,006066.OF,006067.OF,006068.OF,006069.OF,006070.OF,006071.OF,006082.OF,006083.OF,006086.OF,006088.OF,006089.OF,006090.OF,006091.OF,006092.OF,006093.OF,006094.OF,006095.OF,006096.OF,006097.OF,006099.OF,006107.OF,006108.OF,006112.OF,006116.OF,006120.OF,006134.OF,006135.OF,006137.OF,006142.OF,006145.OF,006146.OF,006149.OF,006150.OF,006151.OF,006152.OF,006153.OF,006169.OF,006170.OF,006171.OF,006172.OF,006173.OF,006174.OF,006177.OF,006178.OF,006180.OF,006183.OF,006184.OF,006185.OF,006186.OF,006187.OF,006188.OF,006191.OF,006192.OF,006203.OF,006204.OF,006206.OF,006210.OF,006211.OF,006212.OF,006213.OF,006219.OF,006222.OF,006237.OF,006242.OF,006258.OF,006264.OF,006275.OF,006276.OF,006284.OF,006287.OF,006288.OF,006300.OF,\
    006301.OF,006304.OF,006316.OF,006325.OF,006326.OF,006331.OF,006332.OF,006333.OF,006337.OF,006338.OF,006340.OF,006358.OF,006359.OF,006367.OF,006368.OF,006378.OF,006383.OF,006384.OF,006393.OF,006394.OF,006403.OF,006404.OF,006405.OF,006406.OF,006411.OF,006412.OF,006421.OF,006422.OF,006423.OF,006427.OF,006428.OF,006431.OF,006432.OF,006443.OF,006444.OF,006450.OF,006453.OF,006454.OF,006461.OF,006464.OF,006465.OF,006468.OF,006470.OF,006471.OF,006475.OF,006488.OF,006489.OF,006490.OF,006495.OF,006498.OF,006499.OF,006504.OF,006505.OF,006506.OF,006508.OF,006509.OF,006510.OF,006513.OF,006514.OF,006544.OF,006549.OF,006552.OF,006554.OF,006558.OF,006559.OF,006563.OF,006565.OF,006570.OF,006571.OF,006572.OF,006576.OF,006577.OF,006582.OF,006583.OF,006584.OF,006588.OF,006589.OF,006596.OF,006599.OF,006612.OF,006617.OF,006625.OF,006631.OF,006632.OF,006635.OF,006636.OF,006637.OF,006638.OF,006639.OF,006640.OF,006641.OF,006653.OF,006660.OF,006661.OF,006665.OF,006666.OF,006667.OF,006670.OF,006674.OF,006681.OF,006683.OF,006684.OF,006686.OF,006706.OF,006707.OF,006708.OF,006714.OF,006715.OF,006716.OF,006717.OF,006725.OF,006731.OF,006732.OF,006737.OF,006742.OF,006747.OF,006750.OF,006754.OF,006758.OF,006760.OF,006761.OF,006762.OF,006764.OF,006767.OF,006771.OF,006776.OF,006777.OF,006782.OF,006788.OF,006789.OF,006790.OF,006791.OF,006795.OF,006811.OF,006812.OF,006826.OF,006827.OF,006828.OF,006837.OF,006838.OF,006841.OF,006842.OF,006846.OF,006847.OF,006850.OF,006853.OF,006854.OF,006855.OF,006856.OF,006865.OF,006869.OF,006884.OF,006885.OF,006889.OF,006901.OF,006913.OF,006914.OF,006915.OF,006916.OF,006917.OF,006919.OF,006920.OF,006927.OF,006929.OF,006934.OF,006935.OF,006936.OF,006941.OF,006944.OF,006946.OF,006949.OF,006953.OF,006954.OF,006955.OF,006956.OF,006958.OF,006963.OF,006964.OF,006970.OF,006974.OF,006975.OF,006978.OF,006979.OF,006980.OF,006984.OF,006985.OF,006986.OF,006987.OF,006988.OF,006993.OF,006994.OF,006995.OF,006996.OF,006997.OF,007008.OF,007009.OF,007023.OF,007024.OF,007025.OF,007036.OF,007037.OF,007038.OF,007050.OF,007053.OF,007054.OF,007055.OF,007061.OF,007062.OF,007068.OF,007069.OF,007075.OF,007086.OF,007088.OF,007091.OF,007099.OF,007102.OF,007103.OF,007104.OF,007105.OF,007116.OF,007117.OF,007118.OF,007121.OF,007145.OF,007158.OF,007161.OF,007162.OF,007167.OF,007168.OF,007173.OF,007174.OF,007175.OF,007176.OF,007179.OF,007184.OF,007185.OF,007189.OF,007190.OF,007196.OF,007199.OF,007200.OF,007201.OF,007206.OF,007212.OF,007213.OF,007214.OF,007215.OF,007220.OF,007224.OF,007225.OF,007256.OF,007260.OF,007262.OF,007263.OF,007264.OF,007265.OF,007268.OF,007269.OF,007278.OF,007279.OF,007286.OF,007292.OF,007295.OF,007296.OF,007302.OF,007309.OF,007311.OF,007312.OF,007321.OF,007323.OF,007327.OF,007328.OF,007329.OF,007330.OF,007331.OF,007332.OF,007333.OF,007336.OF,007337.OF,007338.OF,007342.OF,007347.OF,007348.OF,007351.OF,007352.OF,007358.OF,007359.OF,007370.OF,007371.OF,007372.OF,007373.OF,007374.OF,007375.OF,007376.OF,007377.OF,007378.OF,007391.OF,007392.OF,007396.OF,007406.OF,007408.OF,007409.OF,007417.OF,007418.OF,007419.OF,007420.OF,007425.OF,007427.OF,007428.OF,007429.OF,007430.OF,007432.OF,007433.OF,007435.OF,007437.OF,007438.OF,007440.OF,007441.OF,007442.OF,007445.OF,007447.OF,007451.OF,007454.OF,007459.OF,007461.OF,007462.OF,007478.OF,007480.OF,007482.OF,007488.OF,007489.OF,007492.OF,007496.OF,007500.OF,007510.OF,007511.OF,007513.OF,007516.OF,007517.OF,007520.OF,007525.OF,007526.OF,007532.OF,007535.OF,007536.OF,007537.OF,007540.OF,007544.OF,007545.OF,007546.OF,007551.OF,007552.OF,007554.OF,007555.OF,007556.OF,007557.OF,007558.OF,007559.OF,007560.OF,007561.OF,007562.OF,007563.OF,007564.OF,007565.OF,007566.OF,007567.OF,007568.OF,007572.OF,007573.OF,007576.OF,007584.OF,007585.OF,007587.OF,007588.OF,007589.OF,007591.OF,007595.OF,007596.OF,007598.OF,007600.OF,007609.OF,007610.OF,007611.OF,007612.OF,007616.OF,007617.OF,007618.OF,007619.OF,007622.OF,007623.OF,007624.OF,007625.OF,007640.OF,007641.OF,007642.OF,007644.OF,007645.OF,007646.OF,007647.OF,007653.OF,007654.OF,007659.OF,007670.OF,007676.OF,007677.OF,007680.OF,007681.OF,007682.OF,007683.OF,007684.OF,007691.OF,007692.OF,007693.OF,007699.OF,007701.OF,007702.OF,007703.OF,007704.OF,007706.OF,007707.OF,007710.OF,007711.OF,007712.OF,007714.OF,007715.OF,007716.OF,007719.OF,007720.OF,007723.OF,007736.OF,007738.OF,007739.OF,007740.OF,007741.OF,007744.OF,007745.OF,007756.OF,007758.OF,007759.OF,007761.OF,007762.OF,007767.OF,007768.OF,007769.OF,007772.OF,007778.OF,007828.OF,007829.OF,007830.OF,007836.OF,007837.OF,007838.OF,007845.OF,007852.OF,007859.OF,007860.OF,007867.OF,007870.OF,007871.OF,007877.OF,007878.OF,007888.OF,007889.OF,007890.OF,007907.OF,007908.OF,007909.OF,007913.OF,007914.OF,007928.OF,007930.OF,007931.OF,007935.OF,007936.OF,007941.OF,007942.OF,007948.OF,007949.OF,007953.OF,007954.OF,007955.OF,007957.OF,007958.OF,007967.OF,007969.OF,007970.OF,007979.OF,007981.OF,007982.OF,007985.OF,007986.OF,007987.OF,007988.OF,007989.OF,007990.OF,007991.OF,007996.OF,007997.OF,007998.OF,007999.OF,008000.OF,008002.OF,008003.OF,008004.OF,008012.OF,008013.OF,008014.OF,008017.OF,008018.OF,008019.OF,008027.OF,008028.OF,008030.OF,008031.OF,008032.OF,008039.OF,008040.OF,008046.OF,008047.OF,008048.OF,008049.OF,008064.OF,008081.OF,008102.OF,008104.OF,008105.OF,008106.OF,008111.OF,008117.OF,008118.OF,008130.OF,008139.OF,008146.OF,008147.OF,008160.OF,008161.OF,008165.OF,008170.OF,008171.OF,008172.OF,008173.OF,008202.OF,008203.OF,008206.OF,008207.OF,008211.OF,008214.OF,008215.OF,008217.OF,008219.OF,008223.OF,008224.OF,008225.OF,008226.OF,008229.OF,008231.OF,008242.OF,008243.OF,008255.OF,008266.OF,008267.OF,008268.OF,008278.OF,008287.OF,008288.OF,008289.OF,008296.OF,008302.OF,008316.OF,008322.OF,008323.OF,008333.OF,008338.OF,008339.OF,008344.OF,008349.OF,008352.OF,008355.OF,008360.OF,008361.OF,008362.OF,008363.OF,008366.OF,008369.OF,008386.OF,008392.OF,008394.OF,008395.OF,008398.OF,008406.OF,008409.OF,008411.OF,008414.OF,008426.OF,008427.OF,008428.OF,008429.OF,008452.OF,008453.OF,008460.OF,008463.OF,008464.OF,008465.OF,008466.OF,008471.OF,008472.OF,008473.OF,008474.OF,008475.OF,008476.OF,008478.OF,008484.OF,008485.OF,008486.OF,008487.OF,008489.OF,008490.OF,008493.OF,008495.OF,008496.OF,008503.OF,008509.OF,008510.OF,008516.OF,008517.OF,008521.OF,008522.OF,008523.OF,008529.OF,008530.OF,008535.OF,008536.OF,008539.OF,008540.OF,008548.OF,008554.OF,008556.OF,008557.OF,008558.OF,008559.OF,008560.OF,008561.OF,008566.OF,008567.OF,008568.OF,008571.OF,008572.OF,008575.OF,008580.OF,008581.OF,008582.OF,008594.OF,008595.OF,008596.OF,008597.OF,008605.OF,008606.OF,008607.OF,008608.OF,008610.OF,008611.OF,008612.OF,008613.OF,008614.OF,008615.OF,008616.OF,008620.OF,008624.OF,008628.OF,008636.OF,008637.OF,008642.OF,008643.OF,008644.OF,008645.OF,008648.OF,008649.OF,008650.OF,008651.OF,008654.OF,008659.OF,008661.OF,008662.OF,008663.OF,008668.OF,008669.OF,008670.OF,008674.OF,008675.OF,008676.OF,008678.OF,008684.OF,008685.OF,008688.OF,008689.OF,008690.OF,008691.OF,008692.OF,008693.OF,008698.OF,008699.OF,008700.OF,008703.OF,008710.OF,008711.OF,008717.OF,008718.OF,008721.OF,008722.OF,008724.OF,008728.OF,008729.OF,008730.OF,008731.OF,008732.OF,008735.OF,008738.OF,008739.OF,008740.OF,008741.OF,008745.OF,008746.OF,008747.OF,008748.OF,008756.OF,008759.OF,008760.OF,008762.OF,008765.OF,008766.OF,008767.OF,008771.OF,008772.OF,008780.OF,008785.OF,008791.OF,008792.OF,008796.OF,008797.OF,008798.OF,008799.OF,008802.OF,008803.OF,008804.OF,008805.OF,008806.OF,008807.OF,008808.OF,008818.OF,008824.OF,008825.OF,008829.OF,008857.OF,008858.OF,008862.OF,008863.OF,008868.OF,008873.OF,008874.OF,008875.OF,008876.OF,008877.OF,008880.OF,008881.OF,008882.OF,008883.OF,008896.OF,008900.OF,008902.OF,008904.OF,008921.OF,008925.OF,008937.OF,008938.OF,008951.OF,008952.OF,008953.OF,008968.OF,008982.OF,008993.OF,008994.OF,008995.OF,008996.OF,009001.OF,009002.OF,009018.OF,009019.OF,009021.OF,009022.OF,009037.OF,009038.OF,009041.OF,009042.OF,009044.OF,009045.OF,009050.OF,009053.OF,009081.OF,009082.OF,009083.OF,009084.OF,009091.OF,009104.OF,009105.OF,009118.OF,009122.OF,009123.OF,009148.OF,009166.OF,009167.OF,009168.OF,009177.OF,009178.OF,009203.OF,009204.OF,009207.OF,009212.OF,009235.OF,009236.OF,009237.OF,009238.OF,009252.OF,009253.OF,009254.OF,009255.OF,009256.OF,009267.OF,009276.OF,009278.OF,009279.OF,009282.OF,009283.OF,009284.OF,009287.OF,009288.OF,009289.OF,009290.OF,009291.OF,009292.OF,009293.OF,009294.OF,009295.OF,009298.OF,009299.OF,009303.OF,009304.OF,009305.OF,009306.OF,009309.OF,009310.OF,009323.OF,009338.OF,009339.OF,009343.OF,009344.OF,009349.OF,009350.OF,009356.OF,009357.OF,009386.OF,009396.OF,009397.OF,009399.OF,009403.OF,009404.OF,009405.OF,009406.OF,009407.OF,009408.OF,009417.OF,009418.OF,009434.OF,009435.OF,009443.OF,009444.OF,009450.OF,009451.OF,009452.OF,009453.OF,009457.OF,009458.OF,009459.OF,009461.OF,009462.OF,009463.OF,009464.OF,009483.OF,009484.OF,009495.OF,009496.OF,009506.OF,009509.OF,009510.OF,009523.OF,009524.OF,009533.OF,009543.OF,009544.OF,009552.OF,009553.OF,009561.OF,009567.OF,009577.OF,009578.OF,009579.OF,009580.OF,009583.OF,009584.OF,009585.OF,009587.OF,009599.OF,009600.OF,009604.OF,009605.OF,009632.OF,009633.OF,009642.OF,009643.OF,009666.OF,009670.OF,009673.OF,009674.OF,009679.OF,009685.OF,009699.OF,009711.OF,009732.OF,009738.OF,009748.OF,009749.OF,009756.OF,009759.OF,009760.OF,009761.OF,009765.OF,009770.OF,009771.OF,009780.OF,009784.OF,009785.OF,009786.OF,009788.OF,009792.OF,009793.OF,009799.OF,009802.OF,009809.OF,009814.OF,009815.OF,009816.OF,009831.OF,009832.OF,009833.OF,009834.OF,009836.OF,009839.OF,009844.OF,009845.OF,009851.OF,009866.OF,009871.OF,009889.OF,009890.OF,009894.OF,009895.OF,009906.OF,009920.OF,009921.OF,009922.OF,009923.OF,009933.OF,009934.OF,009947.OF,009953.OF,009979.OF,009980.OF,010035.OF,010083.OF,010084.OF,010085.OF,010086.OF,010087.OF,010092.OF,010099.OF,010139.OF,010140.OF,010191.OF,010192.OF,010223.OF,010226.OF,010227.OF,010232.OF,010233.OF,010240.OF,010241.OF,010247.OF,\
    010248.OF,010251.OF,010252.OF,010254.OF,010255.OF,010256.OF,010258.OF,010259.OF,010278.OF,010279.OF,010294.OF,010295.OF,010309.OF,010310.OF,010353.OF,010354.OF,010397.OF,010440.OF,010459.OF,010462.OF,010463.OF,010464.OF,010467.OF,010468.OF,010471.OF,010472.OF,010476.OF,010477.OF,010479.OF,010482.OF,010485.OF,010486.OF,010501.OF,010502.OF,010507.OF,010527.OF,010580.OF,010607.OF,010621.OF,010626.OF,010627.OF,010631.OF,010632.OF,010634.OF,010635.OF,010638.OF,010639.OF,010653.OF,010719.OF,010733.OF,010734.OF,010753.OF,010767.OF,010768.OF,010794.OF,010836.OF,010848.OF,010856.OF,010884.OF,010917.OF,010918.OF,010946.OF,010959.OF,010960.OF,010973.OF,010976.OF,010983.OF,010986.OF,011007.OF,011029.OF,011038.OF,011039.OF,011067.OF,011080.OF,011083.OF,011088.OF,011094.OF,011101.OF,011115.OF,011116.OF,011141.OF,011166.OF,011187.OF,011245.OF,011262.OF,011263.OF,011292.OF,011294.OF,011310.OF,011311.OF,011464.OF,011465.OF,011489.OF,011490.OF,011496.OF,011497.OF,011529.OF,011597.OF,011617.OF,011642.OF,011655.OF,011658.OF,011659.OF,011660.OF,011683.OF,011719.OF,011742.OF,011890.OF,011910.OF,011929.OF,011943.OF,011944.OF,011946.OF,011947.OF,011950.OF,011953.OF,011954.OF,011955.OF,011960.OF,011968.OF,011985.OF,011986.OF,012016.OF,012035.OF,012059.OF,012092.OF,012115.OF,012118.OF,012133.OF,012134.OF,012136.OF,012273.OF,012274.OF,012279.OF,012280.OF,012285.OF,012286.OF,012290.OF,012291.OF,012296.OF,012352.OF,012353.OF,012376.OF,012381.OF,012392.OF,012393.OF,012413.OF,012418.OF,012451.OF,012465.OF,012489.OF,012490.OF,012566.OF,012567.OF,012603.OF,012622.OF,012623.OF,012624.OF,012625.OF,012750.OF,012774.OF,012775.OF,012797.OF,012825.OF,012858.OF,012859.OF,012890.OF,012897.OF,012947.OF,013057.OF,013058.OF,013077.OF,013131.OF,013156.OF,013168.OF,013202.OF,013203.OF,013265.OF,013391.OF,040026.OF,040040.OF,040041.OF,050006.OF,050027.OF,050106.OF,070037.OF,070038.OF,090023.OF,091023.OF,100018.OF,100058.OF,100066.OF,100068.OF,100072.OF,100073.OF,110037.OF,110038.OF,160128.OF,160129.OF,160515.OF,160523.OF,160618.OF,160621.OF,160622.OF,161014.OF,161015.OF,161019.OF,161117.OF,161603.OF,161618.OF,161619.OF,161693.OF,161716.OF,161820.OF,161823.OF,161824.OF,161911.OF,162108.OF,162715.OF,162716.OF,163210.OF,163211.OF,163825.OF,163907.OF,164210.OF,164509.OF,164510.OF,164703.OF,164810.OF,166016.OF,166803.OF,166902.OF,166903.OF,166904.OF,166905.OF,202108.OF,202110.OF,206015.OF,206018.OF,217003.OF,217203.OF,261002.OF,261102.OF,270043.OF,270044.OF,270045.OF,270046.OF,270048.OF,270049.OF,360019.OF,371020.OF,371120.OF,380005.OF,380006.OF,400030.OF,410004.OF,410005.OF,450018.OF,450019.OF,460008.OF,460108.OF,470030.OF,485019.OF,485119.OF,501100.OF,519060.OF,519061.OF,519118.OF,519119.OF,519121.OF,519122.OF,519137.OF,519138.OF,519152.OF,519153.OF,519160.OF,519161.OF,519188.OF,519189.OF,519206.OF,519207.OF,519208.OF,519209.OF,519220.OF,519225.OF,519226.OF,519322.OF,519323.OF,519328.OF,519329.OF,519330.OF,519331.OF,519332.OF,519333.OF,519334.OF,519335.OF,519622.OF,519632.OF,519648.OF,\
    519654.OF,519662.OF,519663.OF,519669.OF,519675.OF,519717.OF,519718.OF,519720.OF,519722.OF,519723.OF,519725.OF,519740.OF,519743.OF,519745.OF,519746.OF,519748.OF,519762.OF,519763.OF,519776.OF,519777.OF,519782.OF,519783.OF,519784.OF,519785.OF,519786.OF,519787.OF,519940.OF,519941.OF,519942.OF,519943.OF,519944.OF,519945.OF,519953.OF,519955.OF,519972.OF,519973.OF,519985.OF,530014.OF,530021.OF,530029.OF,531021.OF,550012.OF,550013.OF,550018.OF,550019.OF,590009.OF,590010.OF,620009.OF,650001.OF,650002.OF,660016.OF,675041.OF,675043.OF,675051.OF,675053.OF,675091.OF,675093.OF,675100.OF,\
    675111.OF,675113.OF,675161.OF,675163.OF,686868.OF,686869.OF,690012.OF,700005.OF,700006.OF,750002.OF,750003.OF,860012.OF,860033.OF,970001.OF,970002.OF,970022.OF,970029.OF,970030.OF,970031.OF,980003.OF,H202108.OF',\
    'ths_fund_scale_fund','2021-08-23').data
df.to_excel('bond_fund_scale.xlsx',index=False)
c_l = df.loc[df.ths_fund_scale_fund>500000000].thscode.to_list()



d = THS_DateSerial(','.join(c_l),\
    'ths_bond_mv_to_fatv_fund;ths_nb_mv_to_bond_invest_mv_fund;ths_fb_mv_to_bond_invest_mv_ratio_fund;ths_cb_mv_to_bond_invest_mv_fund;ths_other_bond_mv_to_bi_mv_fund',\
    ';;;;','Days:Tradedays,Fill:Previous,Interval:Q',\
    '2016-01-01','2021-08-16',True)
dd= THS_Trans2DataFrame(d)

dd['else'] = dd.iloc[:,-2:].sum(axis=1)
code_list=dd.loc[(dd['else']<10)&(dd['ths_bond_mv_to_fatv_fund']>85),\
    'thscode'].unique().tolist()
len(code_list)


df = pd.read_excel('Z:\\Users\\wdt\\Desktop\\tpy\\Modules\\signals\\dur_tot_fund_scale.xlsx')
up5 = df.loc[df['ths_fund_scale_fund']>500000000,'thscode'].tolist()





d = THS_DS(','.join(up5),'ths_adjustment_nvg_rate_fund',\
    '','','2021-08-12','2021-08-22')
nav1 = d.data
nav1.index=  nav1.time
tmp = pd.DataFrame(index = nav1.time.unique(),columns = up5)
for c in tmp.columns:
    tmp[c] = nav1.loc[nav1.thscode==c,'ths_adjustment_nvg_rate_fund']
nav_v1 = pd.read_excel('Z:\\Users\\wdt\\Desktop\\tpy\\Modules\\signals\\fund_nav_v1.xlsx',index_col=0)
nav_v1 = nav_v1.append(tmp)
nav_v1.to_excel('fund_nav_v1.xlsx')

name = 'fund_nav_v1'
nav_v1['date'] = nav_v1.index
columns_type =[DECIMAL(10,6) for _ in range(nav_v1.shape[1]-1)]+[DateTime()]
dtypelist = dict(zip(nav_v1.columns,columns_type))
do.upload_data(nav_v1,name,dtypelist,'replace')


# scale = pd.read_excel('bond_fund_scale.xlsx')
ratio = pd.read_excel('quarter_ratio.xlsx',index_col=0)
ratio['else'] = ratio.iloc[:,-2:].sum(axis=1)
code_list=ratio.loc[(ratio['else']<10)&(ratio['ths_bond_mv_to_fatv_fund']>85),\
    'thscode'].unique().tolist()
## * nav_v2
_,dff=w.wsd(','.join(code_list), \
    "NAV_adj_return1", "2018-01-01", "2021-08-22", "",usedf=True)
_,dff2=w.wsd(','.join(code_list), \
    "NAV_adj_return1", "2016-01-01", "2018-01-01", "",usedf=True)

dff['date'] = dff.index
columns_type =[DECIMAL(10,6) for _ in range(dff.shape[1]-1)]+[DateTime()]
dtypelist = dict(zip(dff.columns,columns_type))


dff.to_excel('2018.xlsx')
dff2.to_excel('2016.xlsx')

nav_v2 = dff2.append(dff)
name = 'fund_nav_v2'
nav_v2['date'] = nav_v2.index
columns_type =[DECIMAL(10,6) for _ in range(nav_v2.shape[1]-1)]+[DateTime()]
dtypelist = dict(zip(nav_v2.columns,columns_type))
do.upload_data(nav_v2,name,dtypelist,'replace')

nav_v2.to_excel('fund_nav_v2.xlsx',index=False)

nav_v2